<head>
<style>
  td {
    padding: 0.2rem 0.5rem;
  }

  tfoot,
  thead {
    font-weight: bold;
    background-color: #d6d6d6;
  }

  tbody > tr:nth-of-type(2n+1) {
    background-color: #f9f9f9;
  }
</style>
</head>
<body style="margin:0;font-family:helvetica;background-color:#e0e0e0;display:flex;justify-content:center">
  <div style="background-color:#fff;padding:1rem 2rem">
    <h1>Equipment Mannequin</h1>
    <h2>Equipment</h2>
    <div id="equipment">
      <h3>Head</h3>
      <table id="head" style="display:none;"><tbody></tbody></table>
      <h3>Neck</h3>
      <table id="neck" style="display:none;"><tbody></tbody></table>
      <h3>Arms</h3>
      <table id="arms" style="display:none;"><tbody></tbody></table>
      <h3>Hands</h3>
      <table id="hands" style="display:none;"><tbody></tbody></table>
      <h3>Chest</h3>
      <table id="chest" style="display:none;"><tbody></tbody></table>
      <h3>Abdomen</h3>
      <table id="abdomen" style="display:none;"><tbody></tbody></table>
      <h3>Back</h3>
      <table id="back" style="display:none;"><tbody></tbody></table>
      <h3>Legs</h3>
      <table id="legs" style="display:none;"><tbody></tbody></table>
      <h3>Feet</h3>
      <table id="feet" style="display:none;"><tbody></tbody></table>
    </div>
    <div style="display:flex;justify-content:center">
      <h2>Armour for</h2>
      <select id="area-filter" style="margin: auto 0.5rem;font-size:1rem;font-weight:bold">
        <option value="-">Everywhere</option>
        <option value="head">Head</option>
        <option value="neck">Neck</option>
        <option value="arms">Arms</option>
        <option value="hands">Hands</option>
        <option value="chest">Chest</option>
        <option value="abdomen">Abdomen</option>
        <option value="back">Back</option>
        <option value="legs">Legs</option>
        <option value="feet">Feet</option>
      </select>
    </div>
    <table id="armours"></table>
  </div>
  <script type="text/javascript">
    const csvUrl = "armours.csv";

    document.getElementById('area-filter').addEventListener("change",(e) => {
      const selection = e.target.selectedOptions[0].value;
      const table = document.getElementById('armours');
      for (const row of table.querySelectorAll('tbody > tr')) {
        if (row.childNodes[9].innerHTML === selection || selection === "-") {
          row.style.display = null;
          continue;
        }
        row.style.display = "none";
      }
    });

    const parseCsv = async ( strData, strDelimiter ) => {
      strDelimiter = (strDelimiter || ",");

      var objPattern = new RegExp(
        (
          "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
          "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
          "([^\"\\" + strDelimiter + "\\r\\n]*))"
        ),
        "gi"
      );

      var arrData = [[]];
      var arrMatches = null;

      while (arrMatches = objPattern.exec( strData )){
        var strMatchedDelimiter = arrMatches[ 1 ];
        if (
          strMatchedDelimiter.length &&
          strMatchedDelimiter !== strDelimiter
        ){
          arrData.push( [] );
        }

        var strMatchedValue;
        if (arrMatches[ 2 ]){
          strMatchedValue = arrMatches[ 2 ].replace(
            new RegExp( "\"\"", "g" ),
            "\""
          );
        } else {
          strMatchedValue = arrMatches[ 3 ];
        }
        arrData[ arrData.length - 1 ].push( strMatchedValue );
      }
      return( arrData );
    }

    const updateVurdere = (table, column) => {
      let total = 0;
      for (const row of table.getElementsByTagName('tbody')[0].childNodes) {
        const text = row.childNodes[column].innerHTML;
        console.log(text.split(" ")[0]);
        switch (text.split(" ")[0]) {
        case "Ineffective":
            break;
        case "Terrible":
            total += 2;
            break;
        case "Amazingly":
            total += 6;
            break;
        case "Pretty":
            total += 10;
            break;
        case "Poor":
            total += 14;
            break;
        case "OK":
            total += 17;
            break;
        case "Average":
            total += 21;
            break;
        case "Good":
            total += 25;
            break;
        case "Very":
            total += 29;
            break;
        case "Extremely":
            total += 32;
            break;
        case "Excellent":
            total += 37;
            break;
        default:
            console.log("Vurdere value unknown, check csv input");
        }
      }
      table.querySelectorAll('tfoot > tr')[0].childNodes[column].innerHTML = total;
    }

    const updateWeight = (table) => {
      let total = 0;
      for (const row of table.getElementsByTagName('tbody')[0].childNodes) {
        const text = row.childNodes[2].innerHTML;
        total += parseInt(text.split(" ")[0]);
      }
      total += " lbs";
      table.querySelectorAll('tfoot > tr')[0].childNodes[2].innerHTML = total;
    }

    const updateTemp = (table) => {
      let total = 0;
      for (const row of table.getElementsByTagName('tbody')[0].childNodes) {
        const text = row.childNodes[3].innerHTML;
        total += parseInt(text);
      }
      table.querySelectorAll('tfoot > tr')[0].childNodes[3].innerHTML = total;
    }

    const updateTable = (table) => {
      if(table.rows.length < 3) {
        table.style.display = "none";
        return;
      }

      table.style.display = "table";
      updateVurdere(table, 4);
      updateVurdere(table, 5);
      updateVurdere(table, 6);
      updateWeight(table);
      updateTemp(table);
    }

    const addRowToTable = (row) => {
      const cells = row.getElementsByTagName('td');
      const targetLayer = cells[9].innerHTML;
      const targetTable = document.getElementById(targetLayer);
      const targetRow = targetTable.querySelectorAll('tbody')[0].insertRow(-1);
      for (const cell of cells) {
        targetRow.insertCell(-1).innerHTML = cell.innerHTML;
      }
      const unequipBox = targetRow.childNodes[10].firstChild;
      unequipBox.addEventListener('click', unequipRow);
      updateTable(targetTable);
    }

    const unequipRow = (e) => {
      const row = e.target.closest('tr');
      const equipName = row.childNodes[0].innerHTML;
      for (const tRow of row.closest('#equipment').querySelectorAll('tbody > tr')) {
        const currentItem = tRow.childNodes[0].innerHTML;
        if (currentItem === equipName) {
          const table = tRow.closest('table');
          tRow.parentNode.removeChild(tRow);
          updateTable(table);
        }
      }
    }

    const equipRow = (e) => {
      const row = e.target.closest('tr');
      const equipName = row.childNodes[0].innerHTML;
      for (const tRow of row.parentNode.childNodes) {
        const currentItem = tRow.childNodes[0].innerHTML;
        if (currentItem === equipName) {
          addRowToTable(tRow);
        }
      }
    }

    const setupEquipmentTables = (csvHeader) => {
      for (const table of document.getElementById("equipment").getElementsByTagName('table')) {
        const header = table.createTHead().insertRow(-1);
        for (const csvValue of csvHeader) {
          header.insertCell(-1).innerHTML = csvValue;
        }
        header.insertCell(-1).innerHTML = 'Unequip';
        const footer = table.createTFoot().insertRow(-1);
        footer.insertCell(-1).innerHTML = 'Total';
        footer.insertCell(-1);
        footer.insertCell(-1).innerHTML = '0';
        footer.insertCell(-1).innerHTML = '0';
        footer.insertCell(-1).innerHTML = '0';
        footer.insertCell(-1).innerHTML = '0';
        footer.insertCell(-1).innerHTML = '0';
        footer.insertCell(-1);
        footer.insertCell(-1);
        footer.insertCell(-1);
        footer.insertCell(-1);
      }
    }

    const request = async () => {
      const response = await fetch(csvUrl);
      const csv = await response.text();
      const csvArray = await parseCsv(csv,';');
      const csvHeader = csvArray.shift();

      setupEquipmentTables(csvHeader);

      const table = document.getElementById("armours");
      for (const csvRow of csvArray) {
        const row = table.insertRow(-1);
        for (const csvValue of csvRow) {
          row.insertCell(-1).innerHTML = csvValue;
        }
        row.insertCell(-1).innerHTML = '<button class="equip">x</button>';
      }
      const header = table.createTHead().insertRow(-1);
      for (const csvValue of csvHeader) {
        header.insertCell(-1).innerHTML = csvValue;
      }
      header.insertCell(-1).innerHTML = 'Equip';

      for (const node of document.querySelectorAll('.equip')) {
        node.addEventListener('click', equipRow);
      }
    }

    request();
  </script>
</body>
